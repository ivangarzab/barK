# .github/workflows/unit-tests.yml
name: Unit Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch: # Allow manual trigger

# Required permissions for test result publishing
permissions:
  contents: read
  checks: write
  pull-requests: write
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  kotlin-tests:
    name: Run Kotlin Tests (Common + Android)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v5

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2 #TODO: Beware of version bump; it breaks the workflow
        with:
          gradle-home-cache-cleanup: true

      - name: Grant Execute Permission for Gradlew
        run: chmod +x gradlew

      - name: Run Common Unit Tests
        run: ./gradlew shared:testDebugUnitTest --continue

      - name: Run Android Unit Tests
        run: ./gradlew sample-android:testDebugUnitTest --continue

      - name: Generate Kover Coverage Report
        run: ./gradlew shared:koverXmlReport shared:koverHtmlReport

      - name: Upload Kotlin Test Results
        uses: actions/upload-artifact@v4
        if: always() # Upload even if tests fail
        with:
          name: kotlin-test-results
          path: |
            **/build/test-results/**/*.xml
            **/build/reports/tests/**
          retention-days: 30

      - name: Upload Kotlin Coverage Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: kotlin-coverage
          path: |
            shared/build/reports/kover/html/
            shared/build/reports/kover/report.xml
          retention-days: 30

      - name: Publish Kotlin Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: |
            **/build/test-results/**/*.xml
          check_name: "Kotlin Test Results"
          comment_title: "Kotlin Test Results"
          fail_on: "test failures"

      - name: Comment PR with Kotlin Test Results
        uses: dorny/test-reporter@v2
        if: always() && github.event_name == 'pull_request'
        with:
          name: 'Kotlin Tests (Common + Android)'
          path: '**/build/test-results/**/*.xml'
          reporter: java-junit
          fail-on-error: true

  # iOS tests
  ios-tests:
    name: Run iOS Tests
    runs-on: macos-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v5

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2 #TODO: Beware of version bump; it breaks the workflow

      - name: Grant Execute Permission for Gradlew
        run: chmod +x gradlew

      - name: Run iOS Unit Tests
        run: ./gradlew shared:iosSimulatorArm64Test --continue

      - name: Generate iOS Kover Coverage Report
        run: ./gradlew shared:koverXmlReport shared:koverHtmlReport

      - name: Upload iOS Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ios-test-results
          path: |
            **/build/test-results/**/*.xml
            **/build/reports/tests/**
          retention-days: 30

      - name: Upload iOS Coverage Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ios-coverage
          path: |
            shared/build/reports/kover/html/
            shared/build/reports/kover/report.xml
          retention-days: 30

      - name: Publish iOS Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: |
            **/build/test-results/**/*.xml
          check_name: "iOS Test Results"
          comment_title: "iOS Test Results"
          fail_on: "test failures"

      - name: Comment PR with iOS Test Results
        uses: dorny/test-reporter@v2
        if: always() && github.event_name == 'pull_request'
        with:
          name: 'iOS Tests'
          path: '**/build/test-results/**/*.xml'
          reporter: java-junit
          fail-on-error: true

  # Test summary job
  test-summary:
    name: Unified Test Summary
    runs-on: ubuntu-latest
    needs: [kotlin-tests, ios-tests]
    if: always()

    steps:
      - name: Download Kotlin Test Results
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: kotlin-test-results
          path: kotlin-test-results

      - name: Download iOS Test Results
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: ios-test-results
          path: ios-test-results

      - name: Download Kotlin Coverage
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: kotlin-coverage
          path: kotlin-coverage

      - name: Download iOS Coverage
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: ios-coverage
          path: ios-coverage

      - name: Generate Unified Test Summary
        run: |
          echo "## ðŸ§ª Multi-Platform Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count Kotlin tests
          KOTLIN_TEST_FILES=$(find kotlin-test-results -name "*.xml" 2>/dev/null | wc -l || echo "0")
          echo "### Kotlin Tests (Common + Android)" >> $GITHUB_STEP_SUMMARY
          if [ "$KOTLIN_TEST_FILES" -gt 0 ]; then
            echo "âœ… **Status:** Tests executed" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“„ **Test files:** $KOTLIN_TEST_FILES" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status:** No test results found" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count iOS tests
          IOS_TEST_FILES=$(find ios-test-results -name "*.xml" 2>/dev/null | wc -l || echo "0")
          echo "### iOS Tests" >> $GITHUB_STEP_SUMMARY
          if [ "$IOS_TEST_FILES" -gt 0 ]; then
            echo "âœ… **Status:** Tests executed" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“„ **Test files:** $IOS_TEST_FILES" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status:** No test results found" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Total
          TOTAL_TEST_FILES=$((KOTLIN_TEST_FILES + IOS_TEST_FILES))
          echo "### ðŸ“Š Total" >> $GITHUB_STEP_SUMMARY
          echo "**Combined test files:** $TOTAL_TEST_FILES" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Coverage Summary
          echo "## ðŸ“ˆ Code Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Parse Kotlin coverage
          if [ -f "kotlin-coverage/report.xml" ]; then
            K_COVERAGE=$(grep -o '<counter type="LINE"[^>]*covered="[0-9]*"[^>]*missed="[0-9]*"' kotlin-coverage/report.xml | head -1 | sed 's/.*covered="\([0-9]*\)".*missed="\([0-9]*\)".*/\1 \2/')
            if [ ! -z "$K_COVERAGE" ]; then
              K_COVERED=$(echo $K_COVERAGE | cut -d' ' -f1)
              K_MISSED=$(echo $K_COVERAGE | cut -d' ' -f2)
              K_TOTAL=$((K_COVERED + K_MISSED))
              K_PERCENTAGE=$((K_TOTAL > 0 ? K_COVERED * 100 / K_TOTAL : 0))
              echo "**Kotlin Coverage:** ${K_PERCENTAGE}% (${K_COVERED}/${K_TOTAL} lines)" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          # Parse iOS coverage
          if [ -f "ios-coverage/report.xml" ]; then
            I_COVERAGE=$(grep -o '<counter type="LINE"[^>]*covered="[0-9]*"[^>]*missed="[0-9]*"' ios-coverage/report.xml | head -1 | sed 's/.*covered="\([0-9]*\)".*missed="\([0-9]*\)".*/\1 \2/')
            if [ ! -z "$I_COVERAGE" ]; then
              I_COVERED=$(echo $I_COVERAGE | cut -d' ' -f1)
              I_MISSED=$(echo $I_COVERAGE | cut -d' ' -f2)
              I_TOTAL=$((I_COVERED + I_MISSED))
              I_PERCENTAGE=$((I_TOTAL > 0 ? I_COVERED * 100 / I_TOTAL : 0))
              echo "**iOS Coverage:** ${I_PERCENTAGE}% (${I_COVERED}/${I_TOTAL} lines)" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          # Combined coverage
          if [ ! -z "$K_TOTAL" ] && [ ! -z "$I_TOTAL" ]; then
            COMBINED_COVERED=$((K_COVERED + I_COVERED))
            COMBINED_TOTAL=$((K_TOTAL + I_TOTAL))
            COMBINED_PERCENTAGE=$((COMBINED_TOTAL > 0 ? COMBINED_COVERED * 100 / COMBINED_TOTAL : 0))
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**ðŸ“Š Combined Coverage:** ${COMBINED_PERCENTAGE}% (${COMBINED_COVERED}/${COMBINED_TOTAL} lines)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ All artifacts retained for 30 days" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ” Check individual test result actions for detailed breakdowns" >> $GITHUB_STEP_SUMMARY